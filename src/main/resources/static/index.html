<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publication System</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <header class="header">
        <div class="logo">Publication System</div>
        <div class="nav-buttons">
            <button id="authButton" onclick="toggleAuth()">Enter</button>
        </div>
    </header>
    
    <main class="container">
        <div id="public-view">
            <h1>Published Publications</h1>
            <div id="published-list"></div>
            <div id="empty-state" class="empty-state hidden">
                <h2>No publications yet</h2>
                <p>Be the first to publish something!</p>
            </div>
        </div>
        
        <div id="auth-view" class="hidden">
            <div class="tabs">
                <button class="tab active" onclick="showTab('create')">Create</button>
                <button class="tab" onclick="showTab('drafts')">Drafts</button>
                <button class="tab" onclick="showTab('published')">Published</button>
            </div>
            
            <div class="tab-content">
                <div id="create-tab">
                    <h2>Create New Publication</h2>
                    <form id="createForm">
                        <div class="form-group">
                            <label for="title">Title:</label>
                            <input type="text" id="title" required placeholder="Enter title...">
                        </div>
                        <div class="form-group">
                            <label for="content">Content:</label>
                            <textarea id="content" rows="6" required placeholder="Write your content here..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="authorId">Author ID:</label>
                            <input type="text" id="authorId" value="author1" required>
                        </div>
                        <button type="submit">Create Draft</button>
                        <button type="button" class="btn-secondary" onclick="showTab('drafts')">View Drafts</button>
                    </form>
                </div>
                
                <div id="drafts-tab" class="hidden">
                    <h2>Draft Publications</h2>
                    <div id="drafts-list"></div>
                </div>
                
                <div id="published-tab" class="hidden">
                    <h2>Published Publications</h2>
                    <div id="published-auth-list"></div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="error" class="error"></div>
    <div id="success" class="success"></div>
    
    <script>
        const API = 'http://localhost:8080/api/publications';
        let isAuthenticated = false;
        
        function toggleAuth() {
            isAuthenticated = !isAuthenticated;
            updateAuthView();
        }
        
        function updateAuthView() {
            const authButton = document.getElementById('authButton');
            const publicView = document.getElementById('public-view');
            const authView = document.getElementById('auth-view');
            
            if (isAuthenticated) {
                authButton.textContent = 'Exit';
                authButton.classList.add('logout');
                publicView.classList.add('hidden');
                authView.classList.remove('hidden');
                loadDrafts();
                loadPublishedAuth();
            } else {
                authButton.textContent = 'Enter';
                authButton.classList.remove('logout');
                publicView.classList.remove('hidden');
                authView.classList.add('hidden');
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('[id$="-tab"]').forEach(t => t.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            if (tabName === 'drafts') loadDrafts();
            if (tabName === 'published') loadPublishedAuth();
        }
        
        async function createPublication(title, content, authorId) {
            const response = await fetch(API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content, authorId })
            });
            if (!response.ok) throw new Error('Failed to create');
            return response.json();
        }
        
        async function updatePublication(id, content) {
            const response = await fetch(`${API}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            if (!response.ok) throw new Error('Cannot update');
            return response.json();
        }
        
        async function publishPublication(id) {
            const response = await fetch(`${API}/${id}/publish`, { method: 'POST' });
            if (!response.ok) throw new Error('Cannot publish');
            return response.json();
        }
        
        async function archivePublication(id) {
            const response = await fetch(`${API}/${id}/archive`, { method: 'POST' });
            if (!response.ok) throw new Error('Cannot archive');
            return response.json();
        }
        
        async function deletePublication(id) {
            const response = await fetch(`${API}/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Cannot delete');
        }
        
        async function loadPublished() {
            const response = await fetch(`${API}/published`);
            const publications = await response.json();
            displayPublishedPublic(publications);
        }
        
        async function loadDrafts() {
            const response = await fetch(`${API}/drafts`);
            const drafts = await response.json();
            displayDrafts(drafts);
        }
        
        async function loadPublishedAuth() {
            const response = await fetch(`${API}/published`);
            const publications = await response.json();
            displayPublishedAuth(publications);
        }
        
        function displayPublishedPublic(publications) {
            const container = document.getElementById('published-list');
            const emptyState = document.getElementById('empty-state');
            
            if (publications.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            container.innerHTML = publications.map(pub => `
                <div class="publication published">
                    <h3>${pub.title}</h3>
                    <p>${pub.content}</p>
                    <div class="meta">
                        Author: ${pub.authorId} | <span class="state">${pub.state}</span> | 
                        Published: ${new Date(pub.publishedAt).toLocaleString()}
                    </div>
                </div>
            `).join('');
        }
        
        function displayDrafts(publications) {
            const container = document.getElementById('drafts-list');
            if (publications.length === 0) {
                container.innerHTML = '<p>No drafts found.</p>';
                return;
            }
            container.innerHTML = publications.map(pub => `
                <div class="publication draft" id="pub-${pub.id}">
                    <h3>${pub.title}</h3>
                    <p>${pub.content}</p>
                    <div class="meta">
                        Author: ${pub.authorId} | <span class="state">${pub.state}</span> | 
                        Created: ${new Date(pub.createdAt).toLocaleString()}
                    </div>
                    <div class="actions">
                        <button onclick="editPublication('${pub.id}', '${pub.content.replace(/'/g, "\\'")}')">Edit</button>
                        <button class="btn-success" onclick="handlePublish('${pub.id}')">Publish</button>
                        <button class="btn-danger" onclick="handleDelete('${pub.id}')">Delete</button>
                    </div>
                    <div id="edit-${pub.id}" class="edit-form hidden">
                        <div class="form-group">
                            <label>Content:</label>
                            <textarea id="content-${pub.id}" rows="4">${pub.content}</textarea>
                        </div>
                        <button onclick="handleUpdate('${pub.id}')">Save</button>
                        <button class="btn-secondary" onclick="cancelEdit('${pub.id}')">Cancel</button>
                    </div>
                </div>
            `).join('');
        }
        
        function displayPublishedAuth(publications) {
            const container = document.getElementById('published-auth-list');
            if (publications.length === 0) {
                container.innerHTML = '<p>No published publications.</p>';
                return;
            }
            container.innerHTML = publications.map(pub => `
                <div class="publication published">
                    <h3>${pub.title}</h3>
                    <p>${pub.content}</p>
                    <div class="meta">
                        Author: ${pub.authorId} | <span class="state">${pub.state}</span> | 
                        Created: ${new Date(pub.createdAt).toLocaleString()}<br>
                        Published: ${new Date(pub.publishedAt).toLocaleString()}
                    </div>
                    <div class="actions">
                        <button class="btn-danger" onclick="handleArchive('${pub.id}')">Archive</button>
                    </div>
                </div>
            `).join('');
        }
        
        function editPublication(id, content) {
            document.getElementById(`edit-${id}`).classList.remove('hidden');
        }
        
        function cancelEdit(id) {
            document.getElementById(`edit-${id}`).classList.add('hidden');
        }
        
        async function handleUpdate(id) {
            const newContent = document.getElementById(`content-${id}`).value;
            try {
                await updatePublication(id, newContent);
                showSuccess('Publication updated successfully');
                loadDrafts();
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function handlePublish(id) {
            try {
                await publishPublication(id);
                showSuccess('Publication published successfully');
                loadDrafts();
                loadPublished();
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function handleArchive(id) {
            try {
                await archivePublication(id);
                showSuccess('Publication archived successfully');
                loadPublishedAuth();
                loadPublished();
            } catch (error) {
                showError(error.message);
            }
        }
        
        async function handleDelete(id) {
            if (confirm('Are you sure you want to delete this draft?')) {
                try {
                    await deletePublication(id);
                    showSuccess('Draft deleted successfully');
                    loadDrafts();
                } catch (error) {
                    showError(error.message);
                }
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 3000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }
        
        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const authorId = document.getElementById('authorId').value;
            
            try {
                await createPublication(title, content, authorId);
                e.target.reset();
                showSuccess('Draft created successfully');
            } catch (error) {
                showError(error.message);
            }
        });
        
        // Load initial publications
        loadPublished();
    </script>
</body>
</html>
