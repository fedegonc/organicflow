<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
      
<head>
    <title>Editor</title>
</head>

<body>
    <div layout:fragment="content">
        <!-- Messages -->
        <div th:if="${message}" class="success" th:text="${message}"></div>
        <div th:if="${error}" class="error" th:text="${error}"></div>
        
        <h1>Publication Editor</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('create')">Create</button>
            <button class="tab" onclick="showTab('drafts')">Drafts</button>
            <button class="tab" onclick="showTab('published')">Published</button>
        </div>
        
        <div class="tab-content">
            <div id="create-tab">
                <h2>Create New Publication</h2>
                <form th:action="@{/api/publications}" method="post">
                    <div class="form-group">
                        <label for="title">Title:</label>
                        <input type="text" id="title" name="title" required placeholder="Enter title...">
                    </div>
                    <div class="form-group">
                        <label for="content">Content:</label>
                        <textarea id="content" name="content" rows="6" required placeholder="Write your content here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="authorId">Author ID:</label>
                        <input type="text" id="authorId" name="authorId" value="author1" required>
                    </div>
                    <div th:replace="~{fragments/components/button :: submit('Create Draft')}"></div>
                    <div th:replace="~{fragments/components/button :: secondary('View Drafts', 'showTab(\'drafts\')')}"></div>
                </form>
            </div>
            
            <div id="drafts-tab" class="hidden">
                <h2>Draft Publications</h2>
                <div id="drafts-list"></div>
            </div>
            
            <div id="published-tab" class="hidden">
                <h2>Published Publications</h2>
                <div id="published-list"></div>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="scripts">
        <script>
            // Get base URL dynamically
            const API = window.location.origin + '/api/publications';
            console.log('API Base URL:', API);
            console.log('Current origin:', window.location.origin);
            
            function showTab(tabName) {
                console.log('Switching to tab:', tabName);
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('[id$="-tab"]').forEach(t => t.classList.add('hidden'));
                
                event.target.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                
                if (tabName === 'drafts') loadDrafts();
                if (tabName === 'published') loadPublished();
            }
            
            async function loadDrafts() {
                const url = `${API}/drafts`;
                console.log('Loading drafts from:', url);
                
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    });
                    
                    console.log('Drafts response status:', response.status);
                    console.log('Drafts response headers:', [...response.headers.entries()]);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const drafts = await response.json();
                    console.log('Drafts loaded:', drafts);
                    displayDrafts(drafts);
                } catch (error) {
                    console.error('Error loading drafts:', error);
                    console.error('Error stack:', error.stack);
                    showError(`Failed to load drafts: ${error.message}`);
                }
            }
            
            async function loadPublished() {
                const url = `${API}/published`;
                console.log('Loading published from:', url);
                
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    });
                    
                    console.log('Published response status:', response.status);
                    console.log('Published response headers:', [...response.headers.entries()]);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const publications = await response.json();
                    console.log('Published loaded:', publications);
                    displayPublished(publications);
                } catch (error) {
                    console.error('Error loading published:', error);
                    console.error('Error stack:', error.stack);
                    showError(`Failed to load published: ${error.message}`);
                }
            }
            
            function displayDrafts(publications) {
                const container = document.getElementById('drafts-list');
                if (publications.length === 0) {
                    container.innerHTML = '<p>No drafts found.</p>';
                    return;
                }
                container.innerHTML = publications.map(pub => `
                    <div class="publication draft">
                        <h3>${pub.title}</h3>
                        <p>${pub.content}</p>
                        <div class="meta">
                            Author: ${pub.authorId} | <span class="state">${pub.state}</span> | 
                            Created: ${new Date(pub.createdAt).toLocaleString()}
                        </div>
                        <div class="actions">
                            <button class="btn-success" onclick="handlePublish('${pub.id}')">Publish</button>
                        </div>
                    </div>
                `).join('');
            }
            
            function displayPublished(publications) {
                const container = document.getElementById('published-list');
                if (publications.length === 0) {
                    container.innerHTML = '<p>No published publications.</p>';
                    return;
                }
                container.innerHTML = publications.map(pub => `
                    <div class="publication published">
                        <h3>${pub.title}</h3>
                        <p>${pub.content}</p>
                        <div class="meta">
                            Author: ${pub.authorId} | <span class="state">${pub.state}</span> | 
                            Published: ${new Date(pub.publishedAt).toLocaleString()}
                        </div>
                    </div>
                `).join('');
            }
            
            async function handlePublish(id) {
                const url = `/api/publications/${id}/publish`;
                console.log('Publishing publication:', id);
                console.log('Publish URL:', url);
                
                try {
                    const response = await fetch(url, { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        credentials: 'same-origin'
                    });
                    
                    console.log('Publish response status:', response.status);
                    console.log('Publish response headers:', [...response.headers.entries()]);
                    
                    if (response.ok) {
                        console.log('Publication published successfully');
                        window.location.reload();
                    } else {
                        const error = await response.text();
                        console.error('Publish error response:', error);
                        showError(error);
                    }
                } catch (error) {
                    console.error('Error publishing:', error);
                    console.error('Error stack:', error.stack);
                    showError('Failed to publish: ' + error.message);
                }
            }
            
            function showError(message) {
                console.error('Showing error message:', message);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                document.querySelector('.tab-content').prepend(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }
            
            // Log page load
            console.log('Page loaded successfully');
            console.log('Document ready state:', document.readyState);
        </script>
    </th:block>
</body>
</html>
